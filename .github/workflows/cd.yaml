name: CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  deploy-to-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login to Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Get AKS credentials so kubectl can connect
      - name: Configure kubectl for AKS
        run: |
          az aks get-credentials \
            --resource-group AKSRajProjectResourcetGroup \
            --name RajAKSCluster \
            --overwrite-existing

      # Deploy Kubernetes manifests
      - name: Deploy Kubernetes manifests
        run: |
          kubectl apply -f redis-statefulset.yaml
          kubectl apply -f mongo-statefulset.yaml
          kubectl apply -f backend-deployment-service.yaml
          kubectl apply -f frontend-deployment-service.yaml

      # Update deployments with new Docker images
      - name: Update deployments with new images
        run: |
          kubectl set image deployment/expensy_backend expensy_backend=${{ secrets.DOCKERHUB_USERNAME }}/expensy_backend:${{ github.sha }} --record
          kubectl set image deployment/expensy_frontend expensy_frontend=${{ secrets.DOCKERHUB_USERNAME }}/expensy_frontend:${{ github.sha }} --record

          # Wait for deployments to roll out
          kubectl rollout status deployment/expensy_backend
          kubectl rollout status deployment/expensy_frontend

          # Confirm pods
          kubectl get pods -o wide
